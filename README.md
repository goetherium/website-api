# website-api
API для взаимодействия веб-сайтов с блокчейном Ethereum

Приложение для веб-сайта
Термины
Приложение – набор JavaScript скриптов, реализующий HTTP-сервер, обслуживающий запросы от сайтов.
Сайт – любой сайт, который ведет учёт своих пользователей и предоставляет им личный кабинет.
Условная единица (УЕ) – единица в транзакции, соотв. 1 эфиру в частной сети.
Реалм: поскольку для всех возможных сайтов в приложении используется одна БД для хранения пользователей и их аккаунтов, все API-методы имеют параметр realm, в который нужно передавать строку, идентифицирующую конкретный сайт.

Основные компоненты
Node.js: HTTP-сервер, обслуживающий запросы от сайтов, использует библиотки web3.js и node- postgres.js.
Ethereum: частный блокчейн с алгоритмом поиска блоков PoA (Proof of Authority).
PostregSQL: БД для привязки транзакций к логинам пользователей сайта.

URL
API размещено по адресу https://my.alladin.host

Замечание по версии TLS
Старые версии curl могут не поддерживают TLS v1.3 и HTTP2, например, curl 7.19.7.
Более новые версии, например, 7.38.0 и выше поддерживают.
Проверить это можно выполнив
curl –V
Результат будет примерно такой – указана поддержка библиотеки nghttp2, реализующей HTTP/2:
curl 7.58.0 (x86_64-pc-linux-gnu) libcurl/7.58.0 OpenSSL/1.1.1 zlib/1.2.11 libidn2/2.0.4 libpsl/0.19.1 (+libidn2/2.0.4) nghttp2/1.30.0 librtmp/2.3
Release-Date: 2018-01-24


Протокол взаимодействия
Запросы выполняются методами POST по протоколу JSON-RPC, спецификация см.
https://www.jsonrpc.org/specification 

Пример запроса
curl --header "Content-Type: application/json" --data '{"jsonrpc":"2.0", "method":"userGet","params":{"userLogin":"Account9"}, "id":5}' https://my.alladin.host

Пример успешного ответа
{"jsonrpc":"2.0","id":5,"result":"{"createdDate":"2020-06-16T11:01:21.000Z"}"}

Пример ошибки
{"jsonrpc":"2.0","id":5,"error":{"code":-1005,"message":"Логин Account25 не найден"}}

Закрытый ключ
Для подписания транзакций, каждый аккаунт пользователя имеет свой уникальный закрытый ключ, который хранится в БД PostgreSQL. Это позволяет авторизовавшемуся в приложении пользователю использовать свой закрытый ключ с любого устройства.
Альтернатива – хранение на каждом устройстве пользователя отдельного закрытого ключа. В этом случае пользователь сам управляет своими закрытыми ключами.
Закрытый ключ хранится в БД зашифрованным в виде спец. структуры Web3 keystore v3
Управление закрытыми ключами выполняется через библиотеку web3.js.

Логин и пароль
Пользователь имеет регистрацию на стороннем сайте (ЛК). Для удобства пользователя не будет создаваться отдельная защищенная зона (внутренний ЛК) для работы с блокчейном. Также нельзя использовать пароль к сайту для шифрования закрытого ключа, т.к. пользователь может изменить пароль, а управление закрытым ключом предполагается делать автоматически, прозрачно для пользователя.

Шифрование логина
Логин передается в приложение не в хешированном, а в открытом виде.
Приложение шифрует логин и сохраняет в PostgreSQL в шифрованном виде.
При выдаче списка транзакций приложение расшифровывает логин и выдает его сайту также в открытом виде.
Т.о. в запросах и ответах логин передается в открытом виде, но хранится в БД приложения в шифрованном виде. Т.о. данные в БД обезличены.

Промежуточный пароль сайта
Сайт должен передать в приложение промежуточный пароль для авторизации в приложении. Это может быть любая строка, но она не должно меняться при смене пароля пользователя Личного кабинета сайта, т.к. приложение использует этот промежуточный пароль (после доп. преобразований) для шифрования файла закрытого ключа при регистрации пользователя сайта в приложении. И если он изменится, дешифровка ключа станет не возможным.
Крайне желательно для усиления безопасности, чтобы сайт передавал в приложение (при регистрации пользователя и последующих) запросах хешированный промежуточный пароль, полученные на основе неизменяемых данных пользователя сайта.

API приложения
Замечание.
Приложение в стадии разработки.
TODO: нужен аудит функций приложения на проверку соотв. переданных значений параметров ожидаемому типу данных.

Временная зона
В БД PostgreSQL даты хранятся с учетом зоны (тип данных TIMESTAMPTZ). Это позволит избежать неожиданной разницы во времени, когда вставка даты клиентом NodeJS, находящемся в одной временной зоне, а чтение данных клиентом NodeJS, находящемся в другой временной зоне.

Формат даты и времени
При передаче сайту даты, приложение сериализует дату в JSON-формат в зоне UTC, например "2020-10-03T21:00:00.000Z", где:
символ "T" используется в качестве разделителя;
символ "Z" обозначает время в UTC (zero-смещение).
Сайт также должен передавать в приложение дату в UTC в указанном выше формате, например, "2020-10-03T21:00:00.000Z".
Получая ответ от приложения, сайт должен переводить UTC дату в локальное время зоны пользователя сайта.

Порядок использования API
1.      Сначала нужно создать пользователя методом userAdd. Проверка методом userGet.

2.      Далее создаем аккаунт методом accountAdd.
У одного пользователя допускается неограниченное количество учетных
записей, которые образуют кошелёк (wallet). На первоначальном этапе решено не забивать пользователям голову кошельками, а просто создавать по умолчанию один аккаунт и отображать его адрес в блокчейне. В дальнейшем схему можно развивать. Поэтому при успешном добавлении пользователя сайт может сразу вызвать метод добавления одного аккаунта.
Само API приложения не накладывает ограничение на кол-во аккаунтов у одного пользователя, ограничение первого этапа следует реализовать на сайте.
Адрес аккаунта – уникальный идентификатор в блокчейне, он нужен для проведения всех транзакций. 
Метода удаления аккаунта нет – блокчейн просто не содержит такого. Но в будущем можно будет пометить аккаунт в БД приложения как неактуальный и тогда он не будет выдаваться в списке.

3.      Проверка списка аккаунтов методом accountGetList. При входе в
раздел сайт, сайт делает по логину пользователя запрос в блокчейн и
получает список аккаунтов и баланс по каждому аккаунту. Предполагается
что пока аккаунт будет один.

4.      Баланс пользователя пополняется условными единицами (УЕ) владельцем сайта.
Для этого у владельца сайте должен быть отдельный административный раздел на сайте. Владелец пополняет баланс пользователей по своему усмотрению. Перед этим баланс владельца сайта должен быть пополнен администратором блокчейна. Перевод УЕ пользователям сайта владелец выполняет тем же методом, что и пользователи. В принципе, его аккаунт для блокчейна нечем не отличается от пользовательского аккаунта.

5.      На сайте д.б. возможность отправить транзакции, посмотреть их список, а также детали каждой транзакции.

userAdd 
Добавление пользователя в БД Postgres. Время создания пользователя сохраняется по UTC.
Параметры:
1.	realm – строка: реалм пользователей. Обязательный параметр. Допустимые символы: цифры, латинские буквы, подчеркивание, точка и прочерк.
2.	userLogin – строка: уникальный логин пользователя в пределах реалма.
Обязательный параметр.
Логин должен быть от 8 до 255 символов.
Возвращает:
•	createdDate – дата создания пользователя.
•	Ошибку с кодом -2001, если пользователь уже существует в БД
•	Ошибку с кодом -1001 при ошибке добавления в БД и текстом ошибки.

Пример:
Запрос
{"jsonrpc":"2.0","method":"userAdd","params":{"realm":"mol","userLogin":"Account10"},"id":5}
Упешный результат
{"jsonrpc":"2.0","id":5,"result":{"createdDate":"2020-12-25T12:20:10.000Z"}}
Ошибка
{"jsonrpc":"2.0","id":5,"error":{"code":-1001,"message":"Пользователь с данным логином уже существует"}}

userGet
Проверка существования пользователя
Параметры:
1.	realm – строка: реалм пользователей. Обязательный параметр.
2.	userLogin – строка: уникальный логин пользователя в реалме. Обязательный параметр.
Возвращает:
•	createdDate – дата создания по правилам JSON, см. пример
•	Ошибку с кодом -2002, если пользователь не найден.
•	Ошибку с кодом -1005 и текстом ошибки в остальных случаях.

Пример:
Запрос
{"jsonrpc":"2.0","method":"userGet","params":{"realm":"mol","userLogin":"Account9"},"id":5}
Упешный результат
{"jsonrpc":"2.0","id":5,"result":{"createdDate":"2020-06-08T03:23:30.000Z"}}
Ошибка
{"jsonrpc":"2.0","id":5,"error":{"code":-1005,"message":"Логин Account25 не найден"}}

accountAdd
Добавление учетной записи (аккаунта) пользователя в БД Postgres.  Время создания сохраняется по UTC.
Для отправки в блокчейн транзакций, необходимо пополнить баланс вновь созданного аккаунта (это отдельный процесс, нужно обратиться к владельцу сайта).
У одного пользователя допускается неограниченное количество учетных записей, которые образуют кошелёк (wallet).
При необходимости создания отдельного кошелька необходимо создать нового пользователя.
Учетная запись в БД имеет атрибуты:
•	адрес аккаунта или смартконтракта в блокчейне Ethereum – уникальная 20-ти байтовая строка;
•	название аккаунта для отображения в пользовательском интерфейсе – понятное пользователю обозначение данного адреса;
•	закрытый ключ пользователя, с помощью которого выполняется подписание транзакций. Закрытый ключ храниться в БД PostgreSQL в зашифрованном виде в формате Web3 keystore v3.

Параметры:
1.	realm - строка: реалм пользователей, обязательный параметр.
2.	userLogin – строка: логин пользователя.
Обязательный параметр.
Пользователь с данным логином должен быть добавлен ранее методом userAdd.
3.	accountName – строка: пользовательское название аккаунта
Обязательный параметр.
Не должно превышать 255 символов.
4.	accountPassword – hex-строка без префикса 0x: промежуточный hmac, используемый для получения пароля шифрования закрытого ключа при создании аккаунта. Обязательное поле. См. Пароль шифрования закрытого ключа. Не сохраняется в БД приложения и нужен только для шифрования файла закрытого ключа.

Возвращает:
•	address – префикс 0x + 20 байт: адрес в hex-формате созданного аккаунта в случае успешного создания. Этот адрес сохранять в БД сайта не нужно: список аккаунтов получается соотв. методом.
•	createdDate – дата создания аккаунта.
•	Ошибку с кодом -2001, если аккаунт уже есть в БД.
•	Ошибку с кодом -1002 при ошибке добавления в БД и текстом ошибки.

Пример:
Запрос
{"jsonrpc":"2.0","method":"accountAdd","params":{"realm":"mol","userLogin":"Account9","accountName":"1й аккаунт","accountPassword":"test password"},"id":5}
Успешный результат
{"jsonrpc":"2.0","id":5,"result":{"createdDate":"2020-12-25T12:21:17.000Z","address":"0x1b414103Bb814a1f6633A700331ab2a4C54c26c5"}}
Пример ошибки
{"jsonrpc":"2.0","id":5,"error":{"code":-2001,"message":"Аккаунт уже существует"}}
 
accountGetList 
Получение списка аккаунтов пользователя из БД Postgres. Может использоваться для проверки существования аккаунта.
Параметры:
1.	realm – строка: реалм пользователей. Обязательный параметр.
2.	userLogin – строка: логин пользователя в реалме. Обязательный параметр.
Возвращает:
•	Массив, в котором каждая запись имеет атрибуты:
o	accountAddress – адрес аккаунта в блокчейне
o	accountName – пользовательское наименование для сайта
o	createdDate – дата создания по правилам JSON, см. пример
o	balance – баланс пользователя в эфирах
•	Ошибку с кодом -2002, если аккаунтов нет в БД.
•	Ошибку с кодом -1004 и текстом ошибки в остальных случаях.

Пример:
Запрос
{"jsonrpc":"2.0","method":"accountGetList","params":{"realm":"mol","userLogin":"Account9"},"id":5}
Упешный результат
{"jsonrpc":"2.0","id":5,"result":[{"accountAddress":"0xBf06F62a924a4ee8866b3a33fA1b10818d5f24F8","accountName":"Основной аккаунт","createdDate":"2020-11-13T06:30:22.000Z","balance":"10.11"}]}
Ошибка
{"jsonrpc":"2.0","id":5,"error":{"code":-1004,"message":"Учетных записей для логина Account10 не найдено"}}

txSend
Подписание и отправка транзакции в блокчейн.
Кроме того, транзакция записывается в БД PostgreSQL с указанием времени создания транзакции по UTC.
Дело в том, что блокчейн не предоставляется API получения списка транзакций по адресу аккаунта. Если этого не сделать, то единственный способ поиска транзакций по учетке – полный перебор всех блоков с просмотром адреса отправителя каждой транзакции в блоке. 
В БД записываются данные:
o	адрес отправителя (в смешанном регистре);
o	адрес получателя (в смешанном регистре);
o	хеш транзакции (в нижнем регистре, как возвращается в рецепте);
o	сумма транзакции в wei;
o	дата записи транзакции в БД  (равна дате записи в блокчейн).
Если destinationAddress не указан, будет создан контракт, адрес которого будет указан в результате в атрибуте contractAddress.

Параметры:
1.	accountAddress - префикс 0x + 20 байт адрес в hex-формате: адрес аккаунта (отправителя). Обязательное поле.
2.	destinationAddress - префикс 0x + 20 байт в hex-формате: адрес получателя. Если не указан, будет создан контракт.
3.	etherValue – число: сумма транзакции в эфирах. Необязательный параметр, по умолчанию 0. Допускаются дроби, поэтому сумму транзакции нужно указывать как строку (в кавычках), см.пример.
4.	accountPassword – строка: промежуточный hmac, используемый для получения пароля шифрования закрытого ключа при создании аккаунта. Обязательное поле. 

Возвращает:
•	txHash – префикс 0x + 64 байт хеша отправленной транзакции в hex-формате;
•	blockNumber - номер блока, в которую включена транзакция
•	contractAddress - адрес созданного контракта, если адрес получателя не был указан
•	Ошибку с кодом -2001, если транзакция уже существует в БД
•	Ошибку с кодом -1003 при ошибке отправки транзакции.

Пример.
Отправка транзакции на существующий адрес
{"jsonrpc":"2.0", "method":"txSend", "params":{"accountAddress":"0x6F43ce33C1E9b1Dfc638e4929cdfbF228Fc30864","destinationAddress":"0x294e7Aa37086A7E9fAeedBC07363d57E7a7E4456","etherValue":"0.051","accountPassword":"test password"}, "id":5}

Результат
{"jsonrpc":"2.0","id":5,"result":{"txHash":"0xecd35742d45b31238bb7f5a75bb341e5800170a21631a543c2b836eba669061a","blockNumber":286438}}

Транзакция создания контракта
{"jsonrpс":"2.0", "method":"txSend", "params":{"accountAddress":"0x1b1Bca9b25AE48Cc16948551A004DdE89D27AfCe","etherValue":"0.051","accountPassword":"test password"}, "id":5}

Результат – указан атрибут contractAddress
{"jsonrpc":"2.0","id":5,"result":{"txHash":"0xeeb4bf41e40e1ea35abc45051515e0360c239a40e6584b6fc2e5989b3d62030f","blockNumber":286630,"contractAddress":"0xa3A3ce684Aa9e242AAa5088e60B854064a597f01"}}

Примеры ошибок
При несуществующем адресе отправителя
{"jsonrpc":"2.0","id":5,"error":{"code":-1003,"message":"Учетная запись с адресом 1b1Bca9b25AE48Cc16948551A004DdE89D27AfC1 не найдена"}}
При неверном пароле для расшифровки закрытого ключа
{"jsonrpc":"2.0","id":5,"error":{"code":-1003,"message":"Key derivation failed - possibly wrong password"}}
Недостаточный баланс для отправки транзакции
{"jsonrpc":"2.0","id":5,"error":{"code":-1003,"message":"Returned error: insufficient funds for gas * price + value"}}

txGetList
Получение исходящих/входящих транзакций из БД.
Параметры:
1.	direction - строка: Out - транзакции, сделанные с аккаунта, In - входящие на аккаунта транзакции. Обязательный параметр.
2.	accountAddress – hex-строка: адрес аккаунта пользователя. Обязательный параметр.
3.	dateFrom - дата в JSON-формате: начальная дата транзакций.  Если не указана или в неверном формате, то неделя от текущей даты.
4.	dateTo - дата в JSON-формате: конечная дата транзакций. Если не указана или в неверном формате, то текущая дата.
5.	sortOrder – направление сортировки: Asc - сначала старые транзакции, Desc - сначала новые транзакции, NoSort - без сортировки (по умолчанию)

Возвращает:
•	Массив, в котором каждая запись имеет атрибуты:
o	sourceUserLogin – логин отправителя
o	destUserLogin – логин получателя
o	txHash - hex-строка: хеш транзакции
o	sourceAddress - hex-строка: адрес отправителя
o	destAddress - hex-строка: адрес получателя
o	txCreatedDate - дата в JSON-формате: дата транзакции
o	weiValue – сумма транзакции в wei
o	etherValue - сумма транзакции в эфирах
•	Ошибку с кодом -2002, если транзакций не найдено.
•	Ошибку с кодом -1006 и текстом ошибки в остальных случаях.

Пример:
Запрос
{"jsonrpc":"2.0","method":"txGetList","params":{"direction":"Out","accountAddress":"0x6F43ce33C1E9b1Dfc638e4929cdfbF228Fc30864","dateFrom":"2020-06-14T03:23:30+03:00","dateTo":"2020-06-16T23:59:59+03:00"},"id":5}

Упешный результат
{"jsonrpc":"2.0","id":5,"result": [{"sourceUserLogin":"Account30","destUserLogin":"Account31","txHash":"0xa8b0ea669775ae8031089937b168a2c80ee806395d6c9f16c7f8fc4c3a144b9a","sourceAddress":"0xC4d7AdA8Dc2212a21A53cF430E9E3e789e59A234","destAddress":"0x81Bae0ceFf43237a0811E5789a538a0D9dD5bA50","txCreatedDate":"2020-12-20T01:01:44.000Z","weiValue":"520000000000000000","etherValue":"0.52"}]}
Ошибка

txGet
Получение деталей транзакций из блокчейна.
Параметры:
1.	txHash – hex-строка: хеш транзакции

Возвращает:
•	Массив, в котором каждая запись имеет атрибуты:
o	hash – хеш транзакции
o	nonce – порядковый номер транзакции для данного аккаунта
o	blockHash – хеш блока
o	blockNumber – номер блока, в который был включена транзакция
o	transactionIndex – индекс транзакции в блоке
o	from – адрес отправителя транзакции
o	to – адрес получателя транзакции
o	value – сумма транзакции в эфирах
o	gasUsed – стоимость использованного газа в эфирах
o	gasPrice – цена газа в эфирах
o	input – входные данные транзакции
o	sourceUserLogin – логин отправителя
o	destUserLogin – логин получателя (если определён)
•	Ошибку с кодом -2002, если транзакция не найдена.
•	Ошибку с кодом -1007 и текстом ошибки в остальных случаях.

Пример:
Запрос
{"jsonrpc":"2.0","method":"txGet","params":{"txHash":"0x8adb5b0cc97401600e50ee0c055b592b389419edd31e18eb7bd1a42d1dcdcf71"},"id":5}

Упешный результат
{"jsonrpc":"2.0","id":1,"result":{"hash":"0x597f3f2d090fc66d1a07fa5e11a584d49121d3d9f5a86460198130d1662ffd41","nonce":4,"blockHash":"0x288e3717387df266df4f109ccff64fc41b0ce0812d55707779152831cbeb21d2","blockNumber":1367694,"transactionIndex":0,"from":"0x70Cf3940CDa05eEaCfeb111461bA60029d6a4dED","to":"0xD8eD4e25fe9574E9Ea3Fcb4Ce4c1d9740AA72731","value":"0.65","gasUsed":"0.000000000000021","gasPrice":"0.000000000000000001","input":"0x","sourceUserLogin":"dlukyant@gmail.com","destUserLogin":"dlukyant"}}

Ошибка
{"jsonrpc":"2.0","id":5,"error":{"code":-2002,"message":"Транзакция не найдена"}}
